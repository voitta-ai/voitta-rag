{% extends "base.html" %}

{% block title %}Browse - voitta-rag{% endblock %}

{% block header_actions %}
<span class="user-badge">{{ user.name }}</span>
<a href="/logout" class="btn btn-text">Logout</a>
{% endblock %}

{% block content %}
<div class="browser-container">
    <!-- Toolbar -->
    <div class="toolbar">
        <nav class="breadcrumbs">
            {% for name, path in breadcrumbs %}
            {% if loop.last %}
            <span class="breadcrumb-item current">{{ name }}</span>
            {% else %}
            <a href="/browse{% if path %}/{{ path }}{% endif %}" class="breadcrumb-item">{{ name }}</a>
            <span class="breadcrumb-sep">/</span>
            {% endif %}
            {% endfor %}
        </nav>

        <div class="toolbar-actions">
            <button class="btn btn-secondary" onclick="openCreateFolderModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    <line x1="12" y1="11" x2="12" y2="17"></line>
                    <line x1="9" y1="14" x2="15" y2="14"></line>
                </svg>
                New Folder
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('file-upload').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload
            </button>
            <input type="file" id="file-upload" multiple style="display: none" onchange="uploadFiles(this.files)">
        </div>
    </div>

    <div class="browser-layout">
        <!-- File List -->
        <div class="file-list-container">
            <!-- Column Headers -->
            <div class="file-list-header">
                <div class="col-name">Name</div>
                <div class="col-search">Search</div>
                <div class="col-size">Size</div>
                <div class="col-status">Index</div>
            </div>
            <div class="file-list" id="file-list">
                {% if items %}
                {% for item in items %}
                {% set item_index_status = index_statuses.get(item.path, 'none') if item.is_dir else (file_index_statuses.get(item.path, {}).get('status', 'none')) %}
                {% set file_chunk_count = file_index_statuses.get(item.path, {}).get('chunk_count', 0) if not item.is_dir else 0 %}
                {% set stats = folder_stats.get(item.path, {}) if item.is_dir else {} %}
                {% set item_search_active = folder_search_states.get(item.path, false) if item.is_dir else false %}
                <div class="file-item {% if item.is_dir %}folder{% else %}file{% endif %}"
                     data-path="{{ item.path }}"
                     data-index-status="{{ item_index_status }}"
                     data-search-active="{{ 'true' if item_search_active else 'false' }}"
                     onclick="selectItem(this, '{{ item.path }}', {{ 'true' if item.is_dir else 'false' }})">
                    <div class="col-name">
                        {% if item.is_dir %}
                        <svg viewBox="0 0 24 24" fill="currentColor" class="file-icon folder-icon">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                        {% else %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="file-icon">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        {% endif %}
                        <span class="file-name-text">{{ item.name }}</span>
                    </div>
                    <div class="col-search">
                        {% if item.is_dir %}
                        <label class="inline-toggle" onclick="event.stopPropagation()">
                            <input type="checkbox"
                                   {% if item_search_active %}checked{% endif %}
                                   onchange="toggleSearchActiveInline(this, '{{ item.path }}')">
                            <span class="inline-toggle-slider"></span>
                        </label>
                        {% endif %}
                    </div>
                    <div class="col-size">{% if not item.is_dir %}{{ item.size | filesizeformat }}{% else %}—{% endif %}</div>
                    <div class="col-status">
                        <span class="index-status-tag status-{{ item_index_status or 'none' }}" title="{% if item.is_dir and stats %}{{ stats.get('indexed_files', 0) }} files indexed, {{ stats.get('total_chunks', 0) }} chunks{% elif file_chunk_count %}{{ file_chunk_count }} chunks{% else %}{{ item_index_status or 'none' }}{% endif %}">
                            {% if item.is_dir %}
                                {% if item_index_status == 'indexed' or item_index_status == 'disabled' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                {% elif item_index_status == 'indexing' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm spin">
                                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
                                </svg>
                                {% elif item_index_status == 'pending' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                {% elif item_index_status == 'error' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="15" y1="9" x2="9" y2="15"></line>
                                    <line x1="9" y1="9" x2="15" y2="15"></line>
                                </svg>
                                {% endif %}
                                {% if stats and (stats.get('indexed_files', 0) > 0 or stats.get('total_chunks', 0) > 0) %}
                                <span class="folder-stats">{{ stats.get('indexed_files', 0) }} files{% if stats.get('total_chunks', 0) > 0 %} · {{ stats.get('total_chunks', 0) }}{% endif %}</span>
                                {% elif item_index_status != 'none' %}
                                {{ item_index_status|capitalize }}
                                {% else %}
                                —
                                {% endif %}
                            {% else %}
                                {% if item_index_status == 'indexed' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                {{ file_chunk_count }}
                                {% else %}
                                —
                                {% endif %}
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="empty-icon">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>This folder is empty</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Selected Item Header -->
            <div class="sidebar-section" id="selection-header">
                <h3 id="selected-item-title">
                    {% if current_path %}
                    {{ current_path.split('/')[-1] or 'Root' }}
                    {% else %}
                    No Selection
                    {% endif %}
                </h3>
                <p class="selected-item-path" id="selected-item-path">
                    {% if current_path %}{{ current_path }}{% endif %}
                </p>
            </div>

            <!-- Folder Settings (only for folders) -->
            <div class="sidebar-section" id="folder-settings-section" style="{% if not current_path %}display: none;{% endif %}">
                <h3>Folder Settings</h3>
                <label class="toggle-setting">
                    <input type="checkbox"
                           id="folder-enabled"
                           {% if folder_enabled %}checked{% endif %}
                           onchange="toggleFolderEnabled(this.checked)">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Enable for indexing</span>
                </label>

                <div class="index-status-display">
                    <span class="index-status-label">Index Status:</span>
                    <span class="index-status-value status-{{ current_index_status or 'none' }}" id="index-status-value">
                        {% if current_index_status == 'indexed' %}
                        Indexed
                        {% elif current_index_status == 'indexing' %}
                        Indexing...
                        {% elif current_index_status == 'pending' %}
                        Pending
                        {% elif current_index_status == 'error' %}
                        Error
                        {% else %}
                        Not indexed
                        {% endif %}
                    </span>
                    <button class="btn btn-text btn-reindex" id="btn-reindex" onclick="reindexFolder()" title="Re-scan folder for new/changed files">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- File Index Info (only for files) -->
            <div class="sidebar-section" id="file-index-section" style="display: none;">
                <h3>Index Info</h3>
                <div class="index-info-grid">
                    <div class="index-info-row">
                        <span class="index-info-label">Status:</span>
                        <span class="index-status-value status-none" id="file-index-status-value">Not indexed</span>
                    </div>
                    <div class="index-info-row">
                        <span class="index-info-label">Chunks:</span>
                        <span id="file-chunk-count">—</span>
                    </div>
                    <div class="index-info-row">
                        <span class="index-info-label">Indexed:</span>
                        <span id="file-indexed-at">—</span>
                    </div>
                </div>
            </div>

            <!-- Metadata Section -->
            <div class="sidebar-section">
                <h3>Metadata</h3>
                <div class="metadata-panel" id="metadata-panel">
                    <div id="metadata-content" style="{% if not current_path %}display: none;{% endif %}">
                        <textarea
                            id="metadata-text"
                            class="metadata-textarea"
                            placeholder="Add notes or metadata..."
                            onchange="saveMetadata(this.value)">{{ current_metadata or '' }}</textarea>
                        <p class="metadata-info" id="metadata-info">
                            {% if metadata_user %}Last updated by {{ metadata_user }}{% endif %}
                        </p>
                    </div>
                    <p class="metadata-placeholder" id="metadata-placeholder" style="{% if current_path %}display: none;{% endif %}">
                        Select a folder or file to view metadata
                    </p>
                </div>
            </div>

            <!-- Indexing Stats Section (only for folders) -->
            <div class="sidebar-section" id="indexing-stats-section" style="display: none;">
                <div class="stats-table-container">
                    <table class="stats-table" id="indexing-stats-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Total</th>
                                <th>Indexed</th>
                                <th>Chunks</th>
                            </tr>
                        </thead>
                        <tbody id="indexing-stats-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal" id="create-folder-modal">
    <div class="modal-backdrop" onclick="closeCreateFolderModal()"></div>
    <div class="modal-content">
        <h2>Create New Folder</h2>
        <form onsubmit="createFolder(event)">
            <div class="form-group">
                <label for="folder-name">Folder Name</label>
                <input type="text" id="folder-name" required autofocus>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCreateFolderModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>
{% endblock %}

{% block scripts %}
<script>
    const currentPath = "{{ current_path }}";

    // Initialize WebSocket connection
    initWebSocket();
</script>
{% endblock %}
