{% extends "base.html" %}

{% block title %}Browse - voitta-rag{% endblock %}

{% block header_actions %}
<span class="user-badge">{{ user.name }}</span>
<a href="/logout" class="btn btn-text">Logout</a>
{% endblock %}

{% block content %}
<div class="browser-container">
    <!-- Toolbar -->
    <div class="toolbar">
        <nav class="breadcrumbs">
            {% for name, path in breadcrumbs %}
            {% if loop.last %}
            <span class="breadcrumb-item current">{{ name }}</span>
            {% else %}
            <a href="/browse{% if path %}/{{ path }}{% endif %}" class="breadcrumb-item">{{ name }}</a>
            <span class="breadcrumb-sep">/</span>
            {% endif %}
            {% endfor %}
        </nav>

        <div class="toolbar-actions">
            <button class="btn btn-secondary" onclick="openCreateFolderModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    <line x1="12" y1="11" x2="12" y2="17"></line>
                    <line x1="9" y1="14" x2="15" y2="14"></line>
                </svg>
                New Folder
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('file-upload').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload
            </button>
            <input type="file" id="file-upload" multiple style="display: none" onchange="uploadFiles(this.files)">
        </div>
    </div>

    <div class="browser-layout">
        <!-- File List -->
        <div class="file-list-container">
            <!-- Column Headers -->
            <div class="file-list-header">
                <div class="col-name">Name</div>
                <div class="col-search">Search</div>
                <div class="col-size">Size</div>
                <div class="col-status">Index</div>
            </div>
            <div class="file-list" id="file-list">
                {% if items %}
                {% for item in items %}
                {% set item_index_status = index_statuses.get(item.path, 'none') if item.is_dir else (file_index_statuses.get(item.path, {}).get('status', 'none')) %}
                {% set file_chunk_count = file_index_statuses.get(item.path, {}).get('chunk_count', 0) if not item.is_dir else 0 %}
                {% set stats = folder_stats.get(item.path, {}) if item.is_dir else {} %}
                {% set item_search_active = folder_search_states.get(item.path, false) if item.is_dir else false %}
                {% set item_sync_type = folder_sync_types.get(item.path) or current_sync_type %}
                <div class="file-item {% if item.is_dir %}folder{% else %}file{% endif %}"
                     data-path="{{ item.path }}"
                     data-index-status="{{ item_index_status }}"
                     data-search-active="{{ 'true' if item_search_active else 'false' }}"
                     onclick="selectItem(this, '{{ item.path }}', {{ 'true' if item.is_dir else 'false' }})">
                    <div class="col-name">
                        {% if item.is_dir %}
                        <svg viewBox="0 0 24 24" fill="currentColor" class="file-icon folder-icon">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                        {% else %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="file-icon">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        {% endif %}
                        <span class="file-name-text">{{ item.name }}</span>
                    </div>
                    <div class="col-sync-icon">
                        {% if item_sync_type == 'sharepoint' %}
                        <svg viewBox="0 0 24 24" class="sync-source-icon" title="SharePoint">
                            <circle cx="12" cy="8" r="5" fill="#038387" opacity="0.9"/>
                            <circle cx="7" cy="15" r="4.5" fill="#0364b8" opacity="0.9"/>
                            <circle cx="16" cy="16" r="4" fill="#1490df" opacity="0.9"/>
                        </svg>
                        {% elif item_sync_type == 'google_drive' %}
                        <svg viewBox="0 0 24 24" class="sync-source-icon" title="Google Drive">
                            <path d="M8.5 2L1 15h6.5L15 2H8.5z" fill="#0da960"/>
                            <path d="M15 2l-7.5 13H23L15 2z" fill="#ffd04b"/>
                            <path d="M1 15l3.5 6h15l3.5-6H1z" fill="#4286f4"/>
                        </svg>
                        {% elif item_sync_type == 'github' %}
                        <svg viewBox="0 0 24 24" fill="currentColor" class="sync-source-icon" title="GitHub">
                            <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.115 2.504.337 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                        </svg>
                        {% endif %}
                    </div>
                    <div class="col-search">
                        {% if item.is_dir %}
                        <label class="inline-toggle" onclick="event.stopPropagation()">
                            <input type="checkbox"
                                   {% if item_search_active %}checked{% endif %}
                                   onchange="toggleSearchActiveInline(this, '{{ item.path }}')">
                            <span class="inline-toggle-slider"></span>
                        </label>
                        {% endif %}
                    </div>
                    <div class="col-size">{% if not item.is_dir %}{{ item.size | filesizeformat }}{% elif stats and stats.get('total_size', 0) > 0 %}{{ stats.get('total_size', 0) | filesizeformat }}{% else %}—{% endif %}</div>
                    <div class="col-status">
                        <span class="index-status-tag status-{{ item_index_status or 'none' }}" title="{% if item.is_dir and stats %}{{ stats.get('indexed_files', 0) }} files indexed, {{ stats.get('total_chunks', 0) }} chunks{% elif file_chunk_count %}{{ file_chunk_count }} chunks{% else %}{{ item_index_status or 'none' }}{% endif %}">
                            {% if item.is_dir %}
                                {% if item_index_status == 'indexed' or item_index_status == 'disabled' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                {% elif item_index_status == 'indexing' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm spin">
                                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
                                </svg>
                                {% elif item_index_status == 'pending' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                {% elif item_index_status == 'error' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="15" y1="9" x2="9" y2="15"></line>
                                    <line x1="9" y1="9" x2="15" y2="15"></line>
                                </svg>
                                {% endif %}
                                {% if stats and (stats.get('indexed_files', 0) > 0 or stats.get('total_chunks', 0) > 0) %}
                                <span class="folder-stats">{{ stats.get('indexed_files', 0) }} files{% if stats.get('total_chunks', 0) > 0 %} · {{ stats.get('total_chunks', 0) }}{% endif %}</span>
                                {% elif item_index_status != 'none' %}
                                {{ item_index_status|capitalize }}
                                {% else %}
                                —
                                {% endif %}
                            {% else %}
                                {% if item_index_status == 'indexed' %}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="status-icon-sm">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                {{ file_chunk_count }}
                                {% else %}
                                —
                                {% endif %}
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="empty-icon">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>This folder is empty</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Selected Item Header -->
            <div class="sidebar-section" id="selection-header">
                <h3 id="selected-item-title">
                    {% if current_path %}
                    {{ current_path.split('/')[-1] or 'Root' }}
                    {% else %}
                    No Selection
                    {% endif %}
                </h3>
                <p class="selected-item-path" id="selected-item-path">
                    {% if current_path %}{{ current_path }}{% endif %}
                </p>
            </div>

            <!-- Folder Settings (only for folders) -->
            <div class="sidebar-section" id="folder-settings-section" style="{% if not current_path %}display: none;{% endif %}">
                <h3>Folder Settings</h3>
                <label class="toggle-setting">
                    <input type="checkbox"
                           id="folder-enabled"
                           {% if folder_enabled %}checked{% endif %}
                           onchange="toggleFolderEnabled(this.checked)">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Enable for indexing</span>
                </label>

                <div class="index-status-display">
                    <span class="index-status-label">Index Status:</span>
                    <span class="index-status-value status-{{ current_index_status or 'none' }}" id="index-status-value">
                        {% if current_index_status == 'indexed' %}
                        Indexed
                        {% elif current_index_status == 'indexing' %}
                        Indexing...
                        {% elif current_index_status == 'pending' %}
                        Pending
                        {% elif current_index_status == 'error' %}
                        Error
                        {% else %}
                        Not indexed
                        {% endif %}
                    </span>
                    <button class="btn btn-text btn-reindex" id="btn-reindex" onclick="reindexFolder()" title="Re-scan folder for new/changed files">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                </div>

                <div class="index-status-display" id="folder-sync-status-row" style="display: none;">
                    <span class="index-status-label">Sync:</span>
                    <span class="sync-status-value" id="folder-sync-status-value">—</span>
                    <span class="sync-last-synced" id="folder-sync-last-synced"></span>
                </div>
            </div>

            <!-- Remote Sync (only for folders) -->
            <div class="sidebar-section" id="sync-source-section" style="display: none;">
                <h3>Remote Sync</h3>

                <div class="form-group-compact">
                    <label for="sync-source-type" class="form-label-compact">Source</label>
                    <select id="sync-source-type" class="sync-select" onchange="onSyncSourceTypeChange(this.value)">
                        <option value="">Filesystem (local)</option>
                        <option value="sharepoint">SharePoint</option>
                        <option value="google_drive">Google Drive</option>
                        <option value="github">GitHub</option>
                    </select>
                </div>

                <!-- SharePoint Fields -->
                <div id="sync-fields-sharepoint" class="sync-fields" style="display: none;">
                    <div class="form-group-compact">
                        <label class="form-label-compact">Tenant ID</label>
                        <input type="text" id="sp-tenant-id" class="sync-input" placeholder="xxxxxxxx-xxxx-...">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Client ID</label>
                        <input type="text" id="sp-client-id" class="sync-input" placeholder="App registration client ID">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Client Secret</label>
                        <input type="password" id="sp-client-secret" class="sync-input" placeholder="Client secret">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Site URL</label>
                        <input type="text" id="sp-site-url" class="sync-input" placeholder="https://tenant.sharepoint.com/sites/MySite">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Drive ID</label>
                        <input type="text" id="sp-drive-id" class="sync-input" placeholder="Optional (uses default doc library)">
                    </div>
                    <div class="sp-connect-row">
                        <button class="btn btn-secondary btn-sm" id="btn-sp-connect" onclick="connectSharePoint()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                <polyline points="10 17 15 12 10 7"></polyline>
                                <line x1="15" y1="12" x2="3" y2="12"></line>
                            </svg>
                            Connect
                        </button>
                        <span class="sp-connect-status" id="sp-connect-status"></span>
                    </div>
                </div>

                <!-- Google Drive Fields -->
                <div id="sync-fields-google_drive" class="sync-fields" style="display: none;">
                    <div class="form-group-compact">
                        <label class="form-label-compact">Service Account JSON</label>
                        <textarea id="gd-service-account-json" class="sync-textarea" rows="4" placeholder="Paste service account JSON..."></textarea>
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Folder ID</label>
                        <input type="text" id="gd-folder-id" class="sync-input" placeholder="Google Drive folder ID">
                    </div>
                </div>

                <!-- GitHub Fields -->
                <div id="sync-fields-github" class="sync-fields" style="display: none;">
                    <div class="form-group-compact">
                        <label class="form-label-compact">Token</label>
                        <input type="password" id="gh-token" class="sync-input" placeholder="ghp_... or fine-grained token">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Repository</label>
                        <input type="text" id="gh-repo" class="sync-input" placeholder="owner/repo-name">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Branch</label>
                        <input type="text" id="gh-branch" class="sync-input" placeholder="main" value="main">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Path</label>
                        <input type="text" id="gh-path" class="sync-input" placeholder="subfolder/within/repo (optional)">
                    </div>
                </div>

                <!-- Save + Sync buttons -->
                <div class="sync-actions" id="sync-actions" style="display: none;">
                    <button class="btn btn-primary btn-sm" onclick="saveSyncSource()">Save</button>
                    <button class="btn btn-secondary btn-sm" id="btn-sync-trigger" onclick="triggerRemoteSync()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Sync
                    </button>
                    <button class="btn btn-text btn-sm sync-remove-btn" onclick="removeSyncSource()" title="Remove sync source">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>

                <!-- Sync Status Display -->
                <div class="sync-status-display" id="sync-status-display" style="display: none;">
                    <span class="sync-status-label">Status:</span>
                    <span class="sync-status-value" id="sync-status-value">Idle</span>
                    <span class="sync-last-synced" id="sync-last-synced"></span>
                </div>
            </div>

            <!-- File Index Info (only for files) -->
            <div class="sidebar-section" id="file-index-section" style="display: none;">
                <h3>Index Info</h3>
                <div class="index-info-grid">
                    <div class="index-info-row">
                        <span class="index-info-label">Status:</span>
                        <span class="index-status-value status-none" id="file-index-status-value">Not indexed</span>
                    </div>
                    <div class="index-info-row">
                        <span class="index-info-label">Chunks:</span>
                        <span id="file-chunk-count">—</span>
                    </div>
                    <div class="index-info-row">
                        <span class="index-info-label">Indexed:</span>
                        <span id="file-indexed-at">—</span>
                    </div>
                </div>
            </div>

            <!-- Metadata Section -->
            <div class="sidebar-section">
                <h3>Metadata</h3>
                <div class="metadata-panel" id="metadata-panel">
                    <div id="metadata-content" style="{% if not current_path %}display: none;{% endif %}">
                        <textarea
                            id="metadata-text"
                            class="metadata-textarea"
                            placeholder="Add notes or metadata..."
                            onchange="saveMetadata(this.value)">{{ current_metadata or '' }}</textarea>
                        <p class="metadata-info" id="metadata-info">
                            {% if metadata_user %}Last updated by {{ metadata_user }}{% endif %}
                        </p>
                    </div>
                    <p class="metadata-placeholder" id="metadata-placeholder" style="{% if current_path %}display: none;{% endif %}">
                        Select a folder or file to view metadata
                    </p>
                </div>
            </div>

            <!-- Indexing Stats Section (only for folders) -->
            <div class="sidebar-section" id="indexing-stats-section" style="display: none;">
                <div class="stats-table-container">
                    <table class="stats-table" id="indexing-stats-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Total</th>
                                <th>Indexed</th>
                                <th>Chunks</th>
                            </tr>
                        </thead>
                        <tbody id="indexing-stats-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal" id="create-folder-modal">
    <div class="modal-backdrop" onclick="closeCreateFolderModal()"></div>
    <div class="modal-content">
        <h2>Create New Folder</h2>
        <form onsubmit="createFolder(event)">
            <div class="form-group">
                <label for="folder-name">Folder Name</label>
                <input type="text" id="folder-name" required autofocus>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCreateFolderModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>
{% endblock %}

{% block scripts %}
<script>
    const currentPath = "{{ current_path }}";

    // Initialize WebSocket connection
    initWebSocket();

    // Auto-load current folder stats in sidebar
    if (currentPath) {
        fetch(`/api/details/${encodeURIComponent(currentPath)}`)
            .then(r => r.json())
            .then(data => updateSidebar(data))
            .catch(() => {});
    }
</script>
{% endblock %}
