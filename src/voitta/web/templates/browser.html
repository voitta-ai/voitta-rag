{% extends "base.html" %}

{% block title %}Browse - voitta-rag{% endblock %}

{% block header_actions %}
<span class="user-badge">{{ user.name }}</span>
<a href="/logout" class="btn btn-text">Logout</a>
{% endblock %}

{% block content %}
<div class="browser-container">
    <!-- Toolbar -->
    <div class="toolbar">
        <nav class="breadcrumbs">
            {% for name, path in breadcrumbs %}
            {% if loop.last %}
            <span class="breadcrumb-item current">{{ name }}</span>
            {% else %}
            <a href="/browse{% if path %}/{{ path }}{% endif %}" class="breadcrumb-item">{{ name }}</a>
            <span class="breadcrumb-sep">/</span>
            {% endif %}
            {% endfor %}
        </nav>

        <div class="toolbar-actions">
            <button class="btn btn-secondary" onclick="openCreateFolderModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    <line x1="12" y1="11" x2="12" y2="17"></line>
                    <line x1="9" y1="14" x2="15" y2="14"></line>
                </svg>
                New Folder
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('file-upload').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload
            </button>
            <input type="file" id="file-upload" multiple style="display: none" onchange="uploadFiles(this.files)">
        </div>
    </div>

    <div class="browser-layout">
        <!-- File List -->
        <div class="file-list-container">
            <!-- Column Headers -->
            <div class="file-list-header">
                <div class="col-name">Name</div>
                <div class="col-search">Search</div>
                <div class="col-size">Size</div>
                <div class="col-status">Index</div>
            </div>
            <div class="file-list" id="file-list">
                {% include '_file_list_items.html' %}
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Selected Item Header -->
            <div class="sidebar-section" id="selection-header">
                <h3 id="selected-item-title">
                    {% if current_path %}
                    {{ current_path.split('/')[-1] or 'Root' }}
                    {% else %}
                    No Selection
                    {% endif %}
                </h3>
                <p class="selected-item-path" id="selected-item-path">
                    {% if current_path %}{{ current_path }}{% endif %}
                </p>
            </div>

            <!-- Folder Settings (only for folders) -->
            <div class="sidebar-section" id="folder-settings-section" style="{% if not current_path %}display: none;{% endif %}">
                <h3>Folder Settings</h3>
                <label class="toggle-setting">
                    <input type="checkbox"
                           id="folder-enabled"
                           {% if folder_enabled %}checked{% endif %}
                           onchange="toggleFolderEnabled(this.checked)">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Enable for indexing</span>
                </label>

                <div class="index-status-display">
                    <span class="index-status-label">Index Status:</span>
                    <span class="index-status-value status-{{ current_index_status or 'none' }}" id="index-status-value">
                        {% if current_index_status == 'indexed' %}
                        Indexed
                        {% elif current_index_status == 'indexing' %}
                        Indexing...
                        {% elif current_index_status == 'pending' %}
                        Pending
                        {% elif current_index_status == 'error' %}
                        Error
                        {% else %}
                        Not indexed
                        {% endif %}
                    </span>
                    <button class="btn btn-text btn-reindex" id="btn-reindex" onclick="reindexFolder()" title="Re-scan folder for new/changed files">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                </div>

                <div class="index-status-display" id="folder-sync-status-row" style="display: none;">
                    <span class="index-status-label">Sync:</span>
                    <span class="sync-status-value" id="folder-sync-status-value">—</span>
                    <span class="sync-last-synced" id="folder-sync-last-synced"></span>
                </div>
            </div>

            <!-- Remote Sync (only for folders) -->
            <div class="sidebar-section" id="sync-source-section" style="display: none;">
                <h3>Remote Sync</h3>

                <div class="form-group-compact">
                    <label for="sync-source-type" class="form-label-compact">Source</label>
                    <select id="sync-source-type" class="sync-select" onchange="onSyncSourceTypeChange(this.value)">
                        <option value="">Filesystem (local)</option>
                        <option value="sharepoint">SharePoint</option>
                        <option value="google_drive">Google Drive</option>
                        <option value="github">GitHub</option>
                    </select>
                </div>

                <!-- SharePoint Fields -->
                <div id="sync-fields-sharepoint" class="sync-fields" style="display: none;">
                    <div class="form-group-compact">
                        <label class="form-label-compact">Tenant ID</label>
                        <input type="text" id="sp-tenant-id" class="sync-input" placeholder="xxxxxxxx-xxxx-...">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Client ID</label>
                        <input type="text" id="sp-client-id" class="sync-input" placeholder="App registration client ID">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Client Secret</label>
                        <input type="password" id="sp-client-secret" class="sync-input" placeholder="Client secret">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Site URL</label>
                        <input type="text" id="sp-site-url" class="sync-input" placeholder="https://tenant.sharepoint.com/sites/MySite">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Drive ID</label>
                        <input type="text" id="sp-drive-id" class="sync-input" placeholder="Optional (uses default doc library)">
                    </div>
                    <div class="sp-connect-row">
                        <button class="btn btn-secondary btn-sm" id="btn-sp-connect" onclick="connectSharePoint()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                <polyline points="10 17 15 12 10 7"></polyline>
                                <line x1="15" y1="12" x2="3" y2="12"></line>
                            </svg>
                            Connect
                        </button>
                        <span class="sp-connect-status" id="sp-connect-status"></span>
                    </div>
                </div>

                <!-- Google Drive Fields -->
                <div id="sync-fields-google_drive" class="sync-fields" style="display: none;">
                    <div class="form-group-compact">
                        <label class="form-label-compact">Service Account JSON</label>
                        <textarea id="gd-service-account-json" class="sync-textarea" rows="4" placeholder="Paste service account JSON..."></textarea>
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Folder ID</label>
                        <input type="text" id="gd-folder-id" class="sync-input" placeholder="Google Drive folder ID">
                    </div>
                </div>

                <!-- GitHub Fields -->
                <div id="sync-fields-github" class="sync-fields" style="display: none;">
                    <div class="form-group-compact">
                        <label class="form-label-compact">Token</label>
                        <input type="password" id="gh-token" class="sync-input" placeholder="ghp_... or fine-grained token">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Repository</label>
                        <input type="text" id="gh-repo" class="sync-input" placeholder="owner/repo-name">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Branch</label>
                        <input type="text" id="gh-branch" class="sync-input" placeholder="main" value="main">
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact">Path</label>
                        <input type="text" id="gh-path" class="sync-input" placeholder="subfolder/within/repo (optional)">
                    </div>
                </div>

                <!-- Save + Sync buttons -->
                <div class="sync-actions" id="sync-actions" style="display: none;">
                    <button class="btn btn-primary btn-sm" onclick="saveSyncSource()">Save</button>
                    <button class="btn btn-secondary btn-sm" id="btn-sync-trigger" onclick="triggerRemoteSync()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Sync
                    </button>
                    <button class="btn btn-text btn-sm sync-remove-btn" onclick="removeSyncSource()" title="Remove sync source">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>

                <!-- Sync Status Display -->
                <div class="sync-status-display" id="sync-status-display" style="display: none;">
                    <span class="sync-status-label">Status:</span>
                    <span class="sync-status-value" id="sync-status-value">Idle</span>
                    <span class="sync-last-synced" id="sync-last-synced"></span>
                </div>
            </div>

            <!-- File Index Info (only for files) -->
            <div class="sidebar-section" id="file-index-section" style="display: none;">
                <h3>Index Info</h3>
                <div class="index-info-grid">
                    <div class="index-info-row">
                        <span class="index-info-label">Status:</span>
                        <span class="index-status-value status-none" id="file-index-status-value">Not indexed</span>
                    </div>
                    <div class="index-info-row">
                        <span class="index-info-label">Chunks:</span>
                        <span id="file-chunk-count">—</span>
                    </div>
                    <div class="index-info-row">
                        <span class="index-info-label">Indexed:</span>
                        <span id="file-indexed-at">—</span>
                    </div>
                </div>
            </div>

            <!-- Metadata Section -->
            <div class="sidebar-section">
                <h3>Metadata</h3>
                <div class="metadata-panel" id="metadata-panel">
                    <div id="metadata-content" style="{% if not current_path %}display: none;{% endif %}">
                        <textarea
                            id="metadata-text"
                            class="metadata-textarea"
                            placeholder="Add notes or metadata..."
                            onchange="saveMetadata(this.value)">{{ current_metadata or '' }}</textarea>
                        <p class="metadata-info" id="metadata-info">
                            {% if metadata_user %}Last updated by {{ metadata_user }}{% endif %}
                        </p>
                    </div>
                    <p class="metadata-placeholder" id="metadata-placeholder" style="{% if current_path %}display: none;{% endif %}">
                        Select a folder or file to view metadata
                    </p>
                </div>
            </div>

            <!-- Indexing Stats Section (only for folders) -->
            <div class="sidebar-section" id="indexing-stats-section" style="display: none;">
                <div class="stats-table-container">
                    <table class="stats-table" id="indexing-stats-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Total</th>
                                <th>Indexed</th>
                                <th>Chunks</th>
                            </tr>
                        </thead>
                        <tbody id="indexing-stats-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal" id="create-folder-modal">
    <div class="modal-backdrop" onclick="closeCreateFolderModal()"></div>
    <div class="modal-content">
        <h2>Create New Folder</h2>
        <form onsubmit="createFolder(event)">
            <div class="form-group">
                <label for="folder-name">Folder Name</label>
                <input type="text" id="folder-name" required autofocus>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCreateFolderModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>
{% endblock %}

{% block scripts %}
<script>
    const currentPath = "{{ current_path }}";

    // Initialize WebSocket connection
    initWebSocket();

    // Auto-load current folder stats in sidebar
    if (currentPath) {
        fetch(`/api/details/${encodeURIComponent(currentPath)}`)
            .then(r => r.json())
            .then(data => updateSidebar(data))
            .catch(() => {});
    }
</script>
{% endblock %}
